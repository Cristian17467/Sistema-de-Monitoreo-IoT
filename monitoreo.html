<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Panel de Monitoreo</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<link rel="icon" type="image/png" href="assets/img/favicon.png">

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">

<style>
body{
margin:0;
font-family:'Segoe UI', sans-serif;
background: linear-gradient(-45deg,#0f2027,#1c1c2b,#2c5364,#000000);
background-size:400% 400%;
animation:gradientBG 15s ease infinite;
color:white;
min-height:100vh;
}

@keyframes gradientBG{
0%{background-position:0% 50%;}
50%{background-position:100% 50%;}
100%{background-position:0% 50%;}
}

h2{
text-align:center;
padding:30px;
font-weight:bold;
letter-spacing:2px;
}

.container-panel{
padding:20px 40px 60px 40px;
}

.floor-title{
margin-top:40px;
margin-bottom:20px;
border-left:6px solid #00d4ff;
padding-left:15px;
font-weight:bold;
}

.server-card{
background:rgba(255,255,255,0.08);
backdrop-filter:blur(20px);
border-radius:20px;
padding:20px;
height:100%;
box-shadow:0 10px 30px rgba(0,0,0,0.5);
transition:0.4s;
position:relative;
}

.server-card:hover{
transform:translateY(-6px);
}

.alerta{
animation: parpadeo 1s infinite;
}

@keyframes parpadeo{
0%{opacity:1;}
50%{opacity:0.3;}
100%{opacity:1;}
}

.apagado{
background:rgba(255,0,0,0.15);
text-align:center;
padding:40px;
border-radius:15px;
font-weight:bold;
}

canvas{
margin-top:15px;
}
</style>
</head>

<body>

<h2>üìä PANEL DE MONITOREO EN TIEMPO REAL</h2>

<div id="panelMonitoreo" class="container-panel container-fluid"></div>

<script>

const API = "https://69980de6d66520f95f166acc.mockapi.io/api/v1/servidores";

/* üî• OBTENER DATOS DESDE MOCKAPI */
async function obtenerServidores(){
    let res = await fetch(API);
    return await res.json();
}

/* üî• CALCULAR ESTADO */
function calcularEstado(carga, power){
    if(power === false) return "Apagado";
    if(carga >= 90) return "Cr√≠tico";
    if(carga >= 70) return "Medio";
    return "Estable";
}

/* üî• AGRUPAR POR PISO */
function agruparPorPiso(data){
    const pisos = {};
    data.forEach(s=>{
        if(!pisos[s.floor]) pisos[s.floor]=[];
        pisos[s.floor].push(s);
    });
    return pisos;
}

/* üî• RENDER PRINCIPAL */
async function renderMonitoreo(){

const panel=document.getElementById("panelMonitoreo");
panel.innerHTML="";

let servidores = await obtenerServidores();
if(servidores.length===0){
panel.innerHTML="<div class='alert alert-warning'>No hay servidores registrados</div>";
return;
}

const pisos=agruparPorPiso(servidores);

Object.keys(pisos).sort((a,b)=>a-b).forEach(piso=>{

panel.innerHTML+=`
<h4 class="floor-title">üè¢ Piso ${piso}</h4>
<div class="row" id="piso-${piso}"></div>
`;

const fila=document.getElementById(`piso-${piso}`);

pisos[piso].forEach((servidor,index)=>{

let carga=parseInt(servidor.carga)||0;
let power=servidor.power!==false;
let estado=calcularEstado(carga,power);

if(!power){

fila.innerHTML+=`
<div class="col-md-3 mb-4">
<div class="server-card apagado">
<h5>${servidor.name}</h5>
<p>üî¥ SERVIDOR APAGADO</p>
</div>
</div>
`;

}else{

let colorBarra=
carga>=90?"bg-danger":
carga>=70?"bg-warning":
"bg-success";

let alerta=carga>=90?
"<div class='alert alert-danger alerta mt-2'>‚ö† ANOMAL√çA CR√çTICA - APAGAR DESDE CONTROL</div>"
:"";

fila.innerHTML+=`
<div class="col-md-3 mb-4">
<div class="server-card">

<h5>${servidor.name}</h5>

<p><strong>Estado:</strong> ${estado}</p>
<p><strong>Carga:</strong> ${carga}%</p>

<div class="progress mb-2">
<div class="progress-bar ${colorBarra}"
style="width:${carga}%">
${carga}%
</div>
</div>

${alerta}

<canvas id="chart-${piso}-${index}" height="120"></canvas>

</div>
</div>
`;

setTimeout(()=>{
crearGrafica(`chart-${piso}-${index}`,carga);
},100);

}

});

});

}

/* üî• GR√ÅFICA DONUT */
function crearGrafica(id,valor){

const ctx=document.getElementById(id);

new Chart(ctx,{
type:'doughnut',
data:{
labels:["Uso","Libre"],
datasets:[{
data:[valor,100-valor],
backgroundColor:[
valor>=90?"#ff4d4d":
valor>=70?"#ffc107":
"#00ff88",
"#1c1c2b"
],
borderWidth:0
}]
},
options:{
plugins:{legend:{display:false}},
cutout:"70%"
}
});

}

renderMonitoreo();
setInterval(renderMonitoreo,3000);

</script>

</body>
</html>
