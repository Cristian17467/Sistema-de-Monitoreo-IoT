<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Centro de Control - Sistema TI</title>

<link rel="icon" type="image/png" href="assets/img/favicon.png">

<meta name="viewport" content="width=device-width, initial-scale=1">
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">

<style>
body{
background: linear-gradient(-45deg,#0f2027,#203a43,#2c5364,#000);
background-size:400% 400%;
animation:gradientBG 12s ease infinite;
min-height:100vh;
color:white;
}
@keyframes gradientBG{
0%{background-position:0% 50%;}
50%{background-position:100% 50%;}
100%{background-position:0% 50%;}
}
.card{
background:rgba(255,255,255,0.08);
border-radius:20px;
padding:20px;
margin-bottom:20px;
}
.progress{height:18px;}
.alerta{
animation: parpadeo 1s infinite;
}
@keyframes parpadeo{
0%{opacity:1;}
50%{opacity:0.3;}
100%{opacity:1;}
}
</style>
</head>

<body>

<div class="container mt-5">
<h2 class="text-center mb-4">üéõ Centro de Control General</h2>
<div id="contenedor"></div>
</div>

<script>

const API = "https://69980de6d66520f95f166acc.mockapi.io/api/v1/servidores";

/* üî• OBTENER SERVIDORES DESDE MOCKAPI */
async function obtenerServidores(){
    let res = await fetch(API);
    return await res.json();
}

/* üî• CALCULAR ESTADO AUTOM√ÅTICO */
function calcularEstado(carga, power){

    if(power === false) return "Apagado";

    if(carga >= 90) return "Cr√≠tico";
    if(carga >= 70) return "Medio";
    return "Estable";
}

/* üî• ENCENDER / APAGAR SERVIDOR */
async function toggleServidor(id, actualPower){

    let nuevoPower = !actualPower;
    let nuevaCarga = nuevoPower ? 20 : 0;

    let nuevoEstado = calcularEstado(nuevaCarga, nuevoPower);

    await fetch(`${API}/${id}`,{
        method:"PUT",
        headers:{"Content-Type":"application/json"},
        body:JSON.stringify({
            power:nuevoPower,
            carga:nuevaCarga,
            status:nuevoEstado
        })
    });

    render();
}

/* üî• RENDER PRINCIPAL */
async function render(){

    const contenedor = document.getElementById("contenedor");
    contenedor.innerHTML = "";

    let servidores = await obtenerServidores();

    if(servidores.length === 0){
        contenedor.innerHTML = "<div class='alert alert-warning'>No hay datos.</div>";
        return;
    }

    /* ORDENAR POR PISO */
    servidores.sort((a,b)=> a.floor - b.floor);

    servidores.forEach((s)=>{

        let carga = parseInt(s.carga) || 0;
        let power = s.power !== false; // si no existe lo toma como encendido
        let estado = calcularEstado(carga, power);

        let color = "bg-success";
        let alerta = "";

        if(!power){
            color = "bg-secondary";
        }
        else if(carga >= 70 && carga < 90){
            color = "bg-warning";
        }
        else if(carga >= 90){
            color = "bg-danger";
            alerta = "<div class='alert alert-danger alerta mt-2'>‚ö† SERVIDOR EN ESTADO CR√çTICO</div>";
        }

        contenedor.innerHTML += `
        <div class="card">
            <h5>Servidor Piso ${s.floor} - ${s.name}</h5>
            <p><strong>Piso:</strong> ${s.floor}</p>
            <p><strong>Estado:</strong> ${estado}</p>
            <p><strong>Carga:</strong> ${carga}%</p>

            <div class="progress">
                <div class="progress-bar ${color}" style="width:${carga}%">
                    ${carga}%
                </div>
            </div>

            ${alerta}

            <button class="btn mt-3 ${power?"btn-danger":"btn-success"}"
            onclick="toggleServidor('${s.id}', ${power})">
            ${power?"Apagar":"Encender"}
            </button>
        </div>
        `;
    });
}

render();

/* üî• ACTUALIZACI√ìN AUTOM√ÅTICA CADA 3 SEGUNDOS */
setInterval(render,3000);

</script>

</body>
</html>
